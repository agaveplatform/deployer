---
################################################################################
#
#   AUTH VARIABLES
#   These can be read from the standard openstack environment
#   variables if present in the runtime environment.
#
#   os_authurl
#   domain_name
#   project_name
#   username
#   password
#
#   REQUIRED VARIABLES
#
#   os_vm_name
#   os_region
#   os_flavor
#   os_zone
#   os_image
#   os_keyname
#   os_securitygroup
#   os_network
#
#   OPTIONAL VARIABLES
#   os_ip_address - Set ip if you'd like to assign an existing floating ip address
#   os_skip_floating_ip - True to completely skip assigning any floating ip.
#                       This is helpful when the cloud provider assigns static
#                       ip on every instance by default.
#
################################################################################

- name: Create OpenStack VM
  os_server:
    state: present
    auth:
        auth_url: "{{os_authurl}}"
        domain_name: "{{os_domain}}"
        project_name: "{{os_project}}"
        username: "{{os_username}}"
        password: "{{os_password}}"
    name: "{{os_vm_name}}"
    region_name: "{{os_region}}"
    flavor: "{{os_flavor}}"
    availability_zone: "{{os_zone}}"
    image: "{{os_image}}"
    key_name: "{{os_keyname}}"
    security_groups: "{{os_security_group}},default"
    network: "{{os_network}}"
    auto_ip: no
    wait: yes
    timeout: 300

- name: Get VM Floating IP from existing pool
  os_floating_ip:
    state: present
    auth:
        auth_url: "{{os_authurl}}"
        domain_name: "{{os_domain}}"
        project_name: "{{os_project}}"
        username: "{{os_username}}"
        password: "{{os_password}}"
    server: "{{os_vm_name}}"
    region_name: "{{os_region}}"
    reuse: yes
    wait: yes
    timeout: 300
  when: os_ip_address is undefined and os_skip_floating_ip

- name: Assign the provided Floating IP address to the VM
  os_floating_ip:
    state: present
    auth:
        auth_url: "{{os_authurl}}"
        domain_name: "{{os_domain}}"
        project_name: "{{os_project}}"
        username: "{{os_username}}"
        password: "{{os_password}}"
    server: "{{os_vm_name}}"
    region_name: "{{os_region}}"
    floating_ip_address: {{os_ip_address}}
    reuse: yes
    wait: yes
    timeout: 300
  when: os_ip_address is defined and os_skip_floating_ip is not true
